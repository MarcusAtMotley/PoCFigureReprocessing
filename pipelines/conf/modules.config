/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    PoC Figure Reprocessing - Modules Configuration
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Process-specific arguments, publish directories, and container configurations.
----------------------------------------------------------------------------------------
*/

process {

    // =========================================================================
    // Default publish settings
    // =========================================================================
    publishDir = [
        path: { "${params.outdir}/${task.process.tokenize(':')[-1].toLowerCase()}" },
        mode: params.publish_dir_mode,
        saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
    ]

    // =========================================================================
    // P0: TrimGalore
    // =========================================================================
    withName: 'TRIMGALORE' {
        ext.args   = [
            "--quality ${params.trim_nextseq}",
            "--length ${params.trim_min_length}",
            "--fastqc"
        ].join(' ').trim()
        publishDir = [
            [
                path: { "${params.outdir}/trimmed/${meta.id}" },
                mode: params.publish_dir_mode,
                pattern: "*{trimmed,val}*.fq.gz"
            ],
            [
                path: { "${params.outdir}/trimmed/${meta.id}/fastqc" },
                mode: params.publish_dir_mode,
                pattern: "*{html,zip}"
            ],
            [
                path: { "${params.outdir}/trimmed/${meta.id}/logs" },
                mode: params.publish_dir_mode,
                pattern: "*report.txt"
            ]
        ]
    }

    // =========================================================================
    // P1: DNA SNP Pipeline
    // =========================================================================
    withName: 'P1_DNA_SNP:BISCUIT_ALIGN' {
        ext.args   = ''  // Default biscuit align settings
        publishDir = [
            path: { "${params.outdir}/p1_dna_snp/${meta.id}" },
            mode: params.publish_dir_mode,
            pattern: "*.{bam,bai}"
        ]
    }

    withName: 'P1_DNA_SNP:REVELIO' {
        publishDir = [
            path: { "${params.outdir}/p1_dna_snp/${meta.id}" },
            mode: params.publish_dir_mode,
            pattern: "*.revelio.{bam,bam.bai}"
        ]
    }

    withName: 'P1_DNA_SNP:LOFREQ_CALLPARALLEL' {
        ext.args   = [
            "--call-indels",
            "-q ${params.lofreq_min_bq}",
            "-Q ${params.lofreq_min_bq}",
            "-m ${params.lofreq_min_mq}"
        ].join(' ').trim()
        publishDir = [
            path: { "${params.outdir}/p1_dna_snp/${meta.id}" },
            mode: params.publish_dir_mode,
            pattern: "*.vcf.gz*"
        ]
    }

    // =========================================================================
    // P2: DNA Methylation Pipeline
    // =========================================================================
    withName: 'P2_DNA_METH:BISCUIT_ALIGN' {
        ext.args   = ''  // Default biscuit align settings
        publishDir = [
            path: { "${params.outdir}/p2_dna_methylation/${meta.id}" },
            mode: params.publish_dir_mode,
            pattern: "*.{bam,bai}"
        ]
    }

    withName: 'P2_DNA_METH:BISCUIT_PILEUP' {
        ext.args   = ''  // Default pileup settings
        publishDir = [
            path: { "${params.outdir}/p2_dna_methylation/${meta.id}" },
            mode: params.publish_dir_mode,
            pattern: "*.vcf.gz"
        ]
    }

    // =========================================================================
    // P3: CNV Pipeline
    // =========================================================================
    withName: 'P3_CNV:HISAT2_ALIGN' {
        ext.args   = ''  // Default hisat2 settings
        publishDir = [
            path: { "${params.outdir}/p3_cnv/${meta.id}" },
            mode: params.publish_dir_mode,
            pattern: "*.{bam,bai}"
        ]
    }

    withName: 'P3_CNV:CNVPYTOR_CALL' {
        ext.args   = "-bin_size ${params.cnv_bin_size}"
        publishDir = [
            path: { "${params.outdir}/p3_cnv/${meta.id}" },
            mode: params.publish_dir_mode,
            pattern: "*.{tsv,csv}"
        ]
    }

    withName: 'P3_CNV:INTERGENIC_FILTER' {
        publishDir = [
            path: { "${params.outdir}/p3_cnv/${meta.id}" },
            mode: params.publish_dir_mode,
            pattern: "*_cnv.csv"
        ]
    }

    // =========================================================================
    // Shared RNA Alignment (ALIGN_RNA subworkflow)
    // =========================================================================
    withName: 'ALIGN_RNA:STAR_ALIGN' {
        ext.args   = [
            "--outSAMtype BAM SortedByCoordinate",
            "--outSAMattributes Standard",
            "--quantMode GeneCounts"
            // Note: --readFilesCommand is auto-detected by STAR module based on file extension
        ].join(' ').trim()
        publishDir = [
            path: { "${params.outdir}/p4_rna_counts/${meta.id}" },
            mode: params.publish_dir_mode,
            pattern: "*.{bam,bai}"
        ]
    }

    // =========================================================================
    // P4: RNA Counts Pipeline
    // =========================================================================
    withName: 'P4_RNA_COUNTS:STAR_ALIGN' {
        ext.args   = [
            "--outSAMtype BAM SortedByCoordinate",
            "--outSAMattributes Standard",
            "--quantMode GeneCounts"
            // Note: --readFilesCommand is auto-detected by STAR module based on file extension
        ].join(' ').trim()
        publishDir = [
            path: { "${params.outdir}/p4_rna_counts/${meta.id}" },
            mode: params.publish_dir_mode,
            pattern: "*.{bam,bai}"
        ]
    }

    withName: 'P4_RNA_COUNTS:SUBREAD_FEATURECOUNTS' {
        ext.args   = [
            "-t ${params.featurecounts_feature_type}",
            "-g ${params.featurecounts_group_by}",
            "-B",  // Count at fragment level for PE
            "-C"   // Don't count chimeric fragments
        ].join(' ').trim()
        publishDir = [
            path: { "${params.outdir}/p4_rna_counts/${meta.id}" },
            mode: params.publish_dir_mode,
            pattern: "*featureCounts*"
        ]
    }

    // =========================================================================
    // P5: RNA SNP Pipeline
    // =========================================================================
    withName: 'P5_RNA_SNP:STAR_ALIGN' {
        ext.args   = [
            "--outSAMtype BAM SortedByCoordinate",
            "--outSAMattributes Standard",
            "--twopassMode Basic"
            // Note: --readFilesCommand is auto-detected by STAR module based on file extension
        ].join(' ').trim()
        publishDir = [
            path: { "${params.outdir}/p5_rna_snp/${meta.id}" },
            mode: params.publish_dir_mode,
            pattern: "*.{bam,bai}",
            enabled: false  // Don't publish BAM for RNA SNP by default
        ]
    }

    withName: 'P5_RNA_SNP:REVELIO' {
        publishDir = [
            path: { "${params.outdir}/p5_rna_snp/${meta.id}" },
            mode: params.publish_dir_mode,
            pattern: "*.revelio.{bam,bam.bai}"
        ]
    }

    withName: 'P5_RNA_SNP:LOFREQ_CALLPARALLEL' {
        ext.args   = [
            "--call-indels",
            "-q ${params.lofreq_min_bq}",
            "-Q ${params.lofreq_min_bq}",
            "-m ${params.lofreq_min_mq}"
        ].join(' ').trim()
        publishDir = [
            path: { "${params.outdir}/p5_rna_snp/${meta.id}" },
            mode: params.publish_dir_mode,
            pattern: "*.vcf.gz*"
        ]
    }

    // =========================================================================
    // Samtools Operations (shared across pipelines)
    // =========================================================================
    withName: '.*SAMTOOLS_INDEX' {
        publishDir = [
            path: { "${params.outdir}/${meta.pipeline}/${meta.id}" },
            mode: params.publish_dir_mode,
            pattern: "*.bai"
        ]
    }

    withName: '.*SAMTOOLS_SORT' {
        ext.args   = '-m 4G'
        ext.prefix = { "${meta.id}.sorted" }
    }

    withName: '.*SAMTOOLS_MERGE' {
        ext.prefix = { "${meta.id}.merged" }
    }
}
