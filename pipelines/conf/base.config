/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    PoC Figure Reprocessing - Base Configuration
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Default config options for local execution with Docker.
    Optimized for high-performance compute environments.
----------------------------------------------------------------------------------------
*/

process {

    // Default resource allocation
    cpus   = { 4      * task.attempt }
    memory = { 16.GB  * task.attempt }
    time   = { 4.h    * task.attempt }

    // Error handling - retry on common transient failures
    errorStrategy = { task.exitStatus in ((130..145) + 104 + 175) ? 'retry' : 'finish' }
    maxRetries    = 1
    maxErrors     = '-1'

    // =========================================================================
    // Process Labels - Resource Allocation
    // =========================================================================

    withLabel:process_single {
        cpus   = { 1                    }
        memory = { 8.GB  * task.attempt }
        time   = { 4.h   * task.attempt }
    }

    withLabel:process_low {
        cpus   = { 4     * task.attempt }
        memory = { 16.GB * task.attempt }
        time   = { 4.h   * task.attempt }
    }

    withLabel:process_medium {
        cpus   = { 8     * task.attempt }
        memory = { 32.GB * task.attempt }
        time   = { 8.h   * task.attempt }
    }

    withLabel:process_high {
        cpus   = { 16    * task.attempt }
        memory = { 64.GB * task.attempt }
        time   = { 16.h  * task.attempt }
    }

    withLabel:process_long {
        time   = { 24.h  * task.attempt }
    }

    withLabel:process_high_memory {
        memory = { 128.GB * task.attempt }
    }

    withLabel:error_ignore {
        errorStrategy = 'ignore'
    }

    withLabel:error_retry {
        errorStrategy = 'retry'
        maxRetries    = 2
    }

    // =========================================================================
    // Process-Specific Resource Overrides
    // =========================================================================

    // TrimGalore - lightweight, I/O bound
    withName: '.*TRIMGALORE.*' {
        cpus   = { 4     * task.attempt }
        memory = { 16.GB * task.attempt }
        time   = { 4.h   * task.attempt }
    }

    // Biscuit alignment - memory intensive for bisulfite
    withName: '.*BISCUIT_ALIGN.*' {
        cpus   = { 16    * task.attempt }
        memory = { 64.GB * task.attempt }
        time   = { 12.h  * task.attempt }
    }

    // Biscuit pileup - methylation calling
    withName: '.*BISCUIT_PILEUP.*' {
        cpus   = { 8     * task.attempt }
        memory = { 32.GB * task.attempt }
        time   = { 8.h   * task.attempt }
    }

    // STAR alignment - needs lots of memory for genome loading
    withName: '.*STAR_ALIGN.*' {
        cpus   = { 16    * task.attempt }
        memory = { 48.GB * task.attempt }
        time   = { 8.h   * task.attempt }
    }

    // HISAT2 alignment - for CNV pipeline
    withName: '.*HISAT2_ALIGN.*' {
        cpus   = { 8     * task.attempt }
        memory = { 32.GB * task.attempt }
        time   = { 8.h   * task.attempt }
    }

    // LoFreq variant calling - parallelized
    withName: '.*LOFREQ.*' {
        cpus   = { 8     * task.attempt }
        memory = { 32.GB * task.attempt }
        time   = { 12.h  * task.attempt }
    }

    // FeatureCounts - gene counting
    withName: '.*FEATURECOUNTS.*' {
        cpus   = { 4     * task.attempt }
        memory = { 16.GB * task.attempt }
        time   = { 2.h   * task.attempt }
    }

    // CNVpytor - CNV calling
    withName: '.*CNVPYTOR.*' {
        cpus   = { 4     * task.attempt }
        memory = { 32.GB * task.attempt }
        time   = { 4.h   * task.attempt }
    }

    // Samtools operations - generally lightweight
    withName: '.*SAMTOOLS_SORT.*' {
        cpus   = { 4     * task.attempt }
        memory = { 16.GB * task.attempt }
        time   = { 4.h   * task.attempt }
    }

    withName: '.*SAMTOOLS_INDEX.*' {
        cpus   = { 2                    }
        memory = { 4.GB  * task.attempt }
        time   = { 1.h   * task.attempt }
    }

    withName: '.*SAMTOOLS_MERGE.*' {
        cpus   = { 4     * task.attempt }
        memory = { 16.GB * task.attempt }
        time   = { 4.h   * task.attempt }
    }

    // =========================================================================
    // Scatter-Gather Chunk Processing - Right-sized for smaller inputs
    // Based on actual usage: ~15 GB peak RSS, 2-4% CPU (I/O bound)
    // =========================================================================

    // SPLIT_BAM - splitting BAMs for scatter-gather (I/O bound)
    withName: '.*SPLIT_BAM.*' {
        cpus   = { 2                    }
        memory = { 8.GB  * task.attempt }
        time   = { 2.h   * task.attempt }
    }

    // SPLIT_FASTQ - splitting FASTQs for scatter-gather (I/O bound)
    // Large WGS files can have 1B+ reads = 100+ chunks, needs more time
    withName: '.*SPLIT_FASTQ.*' {
        cpus   = { 4                    }
        memory = { 8.GB  * task.attempt }
        time   = { 8.h   * task.attempt }
    }

    // Revelio on chunks - much smaller than full BAMs
    // Peak RSS ~15 GB, very low CPU usage
    withName: '.*REVELIO_SCATTER_GATHER:REVELIO.*' {
        cpus   = { 4     * task.attempt }
        memory = { 24.GB * task.attempt }
        time   = { 2.h   * task.attempt }
    }

    // Biscuit alignment on chunks - smaller than full FASTQs
    // Based on metrics: ~15 GB peak RSS, 2-4% CPU
    withName: '.*ALIGN_DNA:BISCUIT_ALIGN.*' {
        cpus   = { 4     * task.attempt }
        memory = { 24.GB * task.attempt }
        time   = { 2.h   * task.attempt }
    }
}
