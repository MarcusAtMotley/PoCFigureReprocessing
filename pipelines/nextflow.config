/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    PoC Figure Reprocessing Pipeline - Nextflow Configuration
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Unified pipeline for reprocessing sequencing data to generate 14 PoC figures
    comparing Motley Bio's TrinitySeq (mTNA, HairyTNA) vs traditional sequencing.
----------------------------------------------------------------------------------------
*/

// Global default params
params {

    // =========================================================================
    // Input/Output Options
    // =========================================================================
    input                      = null      // Path to input samplesheet CSV
    outdir                     = null      // Output directory (S3 or local)
    pipeline                   = null      // Specific pipeline to run: p0, p1, p2, p3, p4, p5, or 'all'

    // =========================================================================
    // Reference Genome Options
    // =========================================================================
    // Use S3 paths by default (works for both local Docker and AWS Batch)
    genome_fasta               = "s3://motleybio/Resources/reference_genome/GRCh38_full_analysis_set_plus_decoy_hla.fa"
    genome_fai                 = "s3://motleybio/Resources/reference_genome/GRCh38_full_analysis_set_plus_decoy_hla.fa.fai"
    annotation_gtf             = "s3://motleybio/Resources/GTF/Homo_sapiens.GRCh38.112.chr_label.gtf"

    // Local reference paths (optional, for offline use)
    genome_fasta_local         = "/home/ubuntu/references/fasta/GRCh38_full_analysis_set_plus_decoy_hla.fa"
    annotation_gtf_local       = "/home/ubuntu/references/Homo_sapiens.GRCh38.112.chr_label.gtf"

    // =========================================================================
    // Pre-built Index Paths (skip building if provided)
    // =========================================================================
    biscuit_index              = "s3://motleybio/Resources/biscuit_reference_genome/"
    star_index                 = "s3://motleybio/Resources/Star_Genome/"

    // S3 index paths (same as above, for AWS Batch profile)
    biscuit_index_s3           = "s3://motleybio/Resources/biscuit_reference_genome/"
    star_index_s3              = "s3://motleybio/Resources/Star_Genome/"

    // =========================================================================
    // BED Mask Files (for filtering/analysis)
    // =========================================================================
    intergenic_bed             = null      // BED file for intergenic regions (CNV filtering)
    gene_bodies_bed            = null      // BED file for gene body regions
    promoters_bed              = null      // BED file for promoter regions (TSS Â± 2kb)

    // =========================================================================
    // TrimGalore Options (P0)
    // =========================================================================
    skip_trimming              = false
    trim_nextseq               = 20        // NextSeq/NovaSeq 2-color chemistry quality trimming
    trim_min_length            = 20        // Minimum read length after trimming

    // =========================================================================
    // Alignment Options
    // =========================================================================
    save_unaligned             = false     // Save unaligned reads
    save_secondary             = false     // Save secondary alignments

    // =========================================================================
    // Variant Calling Options
    // =========================================================================
    lofreq_min_cov             = 10        // Minimum coverage for LoFreq
    lofreq_min_bq              = 20        // Minimum base quality for LoFreq
    lofreq_min_mq              = 20        // Minimum mapping quality for LoFreq

    // =========================================================================
    // CNV Calling Options (P3)
    // =========================================================================
    cnv_bin_size               = 10000     // Bin size for CNV calling
    cnv_min_segment_size       = 3         // Minimum segment size

    // =========================================================================
    // RNA Counting Options (P4)
    // =========================================================================
    featurecounts_feature_type = 'exon'           // Feature type for counting
    featurecounts_group_by     = 'gene_id'        // Attribute for grouping

    // =========================================================================
    // AWS Batch Options
    // =========================================================================
    aws_queue                  = null      // AWS Batch job queue name
    aws_region                 = null      // AWS region (defaults to us-east-2)

    // =========================================================================
    // Boilerplate Options
    // =========================================================================
    publish_dir_mode           = 'copy'    // Copy files to output (not symlink for S3)
    monochrome_logs            = false
    help                       = false
    version                    = false
    trace_report_suffix        = new java.util.Date().format('yyyy-MM-dd_HH-mm-ss')
}

// Load base.config for all profiles
includeConfig 'conf/base.config'

// Profile definitions
profiles {
    debug {
        dumpHashes             = true
        process.beforeScript   = 'echo $HOSTNAME'
        cleanup                = false
    }

    docker {
        docker.enabled         = true
        conda.enabled          = false
        singularity.enabled    = false
        podman.enabled         = false
        shifter.enabled        = false
        charliecloud.enabled   = false
        apptainer.enabled      = false
        docker.runOptions      = '-u $(id -u):$(id -g)'
    }

    singularity {
        singularity.enabled    = true
        singularity.autoMounts = true
        conda.enabled          = false
        docker.enabled         = false
        podman.enabled         = false
        shifter.enabled        = false
        charliecloud.enabled   = false
        apptainer.enabled      = false
    }

    awsbatch {
        includeConfig 'conf/awsbatch.config'
    }

    test {
        includeConfig 'conf/test.config'
    }

    local {
        // Local execution with Docker
        docker.enabled         = true
        docker.runOptions      = '-u $(id -u):$(id -g)'
        process.executor       = 'local'
    }
}

// Default registry for containers
docker.registry       = 'quay.io'
singularity.registry  = 'quay.io'

// Export environment variables to prevent conflicts
env {
    PYTHONNOUSERSITE = 1
    R_PROFILE_USER   = "/.Rprofile"
    R_ENVIRON_USER   = "/.Renviron"
}

// Set bash options
process.shell = [
    "bash",
    "-C",         // No clobber
    "-e",         // Exit on error
    "-u",         // Error on unset variables
    "-o", "pipefail"
]

// Disable process selector warnings
nextflow.enable.configProcessNamesValidation = false

// Pipeline reports
timeline {
    enabled = true
    file    = "${params.outdir}/pipeline_info/execution_timeline_${params.trace_report_suffix}.html"
}
report {
    enabled = true
    file    = "${params.outdir}/pipeline_info/execution_report_${params.trace_report_suffix}.html"
}
trace {
    enabled = true
    file    = "${params.outdir}/pipeline_info/execution_trace_${params.trace_report_suffix}.txt"
}
dag {
    enabled = true
    file    = "${params.outdir}/pipeline_info/pipeline_dag_${params.trace_report_suffix}.html"
}

// Manifest
manifest {
    name            = 'PoCFigureReprocessing'
    author          = 'Motley Bio'
    homePage        = 'https://github.com/Motleybio-organization/PoCFigureReprocessing'
    description     = 'Unified pipeline for reprocessing sequencing data for PoC figure generation'
    mainScript      = 'main.nf'
    nextflowVersion = '!>=24.10.0'
    version         = '1.0.0'
}

// Load modules.config for process-specific options
includeConfig 'conf/modules.config'
